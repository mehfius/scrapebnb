<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro CRUD</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://scrapebnb.vercel.app/js/supabase_auth_airbnb.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; 
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .form-input, .form-select {
            @apply block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 text-sm;
        }
        .btn-primary {
            @apply flex-1 flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .btn-secondary {
            @apply flex-1 flex justify-center py-2.5 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500;
        }
        .btn-edit, .btn-delete {
            @apply p-1.5 rounded-lg hover:bg-gray-100 transition-colors;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
    </style>
</head>
<body class="p-6">

    <div class="container">
        
        <header class="flex items-center justify-between gap-4 p-4 mb-8 bg-white shadow-md rounded-lg">
            <div class="flex items-center gap-2">
                <span class="material-symbols-outlined text-blue-500 text-4xl">payments</span>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Gerenciador Financeiro</h1>
                    <p class="text-sm text-gray-600">Adicione e visualize seus lançamentos</p>
                </div>
            </div>
            
            <a href="#" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-blue-700 transition-colors text-sm whitespace-nowrap">Resumo</a>
        </header>

        
        <div class="bg-white shadow-md rounded-lg p-6 mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Novo Lançamento</h2>
            <form id="financial-form" class="space-y-4">
                <div>
                    <label for="label" class="block text-sm font-medium text-gray-700">Descrição</label>
                    <input type="text" id="label" required class="mt-1 form-input">
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="type" class="block text-sm font-medium text-gray-700">Tipo</label>
                        <select id="type" required class="mt-1 form-select">
                            <option value="receita">Receita</option>
                            <option value="despesa">Despesa</option>
                        </select>
                    </div>
                    <div class="w-1/2">
                        <label for="value" class="block text-sm font-medium text-gray-700">Valor</label>
                        <input type="number" id="value" required class="mt-1 form-input">
                    </div>
                </div>
                <div class="flex space-x-4">
                    <div class="w-1/2">
                        <label for="month" class="block text-sm font-medium text-gray-700">Mês</label>
                        <input type="number" id="month" required min="1" max="12" value="1" class="mt-1 form-input">
                    </div>
                    <div class="w-1/2">
                        <label for="year" class="block text-sm font-medium text-gray-700">Ano</label>
                        <input type="number" id="year" required value="2024" class="mt-1 form-input">
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button type="submit" id="submit-btn" class="btn-primary">Adicionar Lançamento</button>
                    <button type="button" id="cancel-btn" class="btn-secondary hidden">Cancelar</button>
                </div>
            </form>
        </div>

        
        <div class="bg-white shadow-md rounded-lg p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Lançamentos</h2>
            <div id="loading-message" class="text-center text-gray-500 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-2">Carregando dados...</p>
            </div>
            <ul id="financial-list" class="space-y-4">
                
            </ul>
            <p id="no-data-message" class="text-center text-gray-500 mt-4 hidden">Nenhum lançamento encontrado.</p>
        </div>
    </div>

    <script type="module">
        
        const form = document.getElementById('financial-form');
        const list = document.getElementById('financial-list');
        const loadingMessage = document.getElementById('loading-message');
        const noDataMessage = document.getElementById('no-data-message');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');

        
        let supabase;
        let editingId = null;

        
        const initializeSupabase = async () => {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    
                    if (typeof globalThis.supabase !== 'undefined') {
                        supabase = globalThis.supabase;
                        resolve();
                    } else {
                        setTimeout(checkSupabase, 100);
                    }
                };
                checkSupabase();
            });
        };

        
        const renderListings = (listings) => {
            list.innerHTML = '';
            if (listings.length === 0) {
                noDataMessage.classList.remove('hidden');
            } else {
                noDataMessage.classList.add('hidden');
                listings.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.id = `item-${item.id}`;
                    
                    const isExpense = item.tipo === 'despesa';
                    const icon = isExpense ? 'payments' : 'add_circle';
                    const valueColor = isExpense ? 'text-red-600' : 'text-green-600';
                    const iconColor = isExpense ? 'text-red-500' : 'text-green-500';
                    const borderColor = isExpense ? 'border-red-200' : 'border-green-200';

                    listItem.className = `p-4 border ${borderColor} rounded-lg shadow-sm flex items-center space-x-4 transition-all hover:shadow-md`;
                    listItem.innerHTML = `
                        <span class="material-symbols-outlined text-2xl ${iconColor}">${icon}</span>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-gray-800">${item.label}</h4>
                            <p class="text-sm text-gray-500">
                                ${item.mes}/${item.ano} - Tipo: <span class="font-medium capitalize">${item.tipo}</span>
                            </p>
                        </div>
                        <p class="font-bold text-lg ${valueColor}">
                            R$ ${((item.valor || 0) / 100).toFixed(2)}
                        </p>
                        <div class="flex space-x-1">
                            <button class="btn-edit" data-id="${item.id}">
                                <span class="material-symbols-outlined text-base text-gray-500 hover:text-blue-500">edit</span>
                            </button>
                            <button class="btn-delete" data-id="${item.id}">
                                <span class="material-symbols-outlined text-base text-gray-500 hover:text-red-500">delete</span>
                            </button>
                        </div>
                    `;
                    list.appendChild(listItem);
                });

                
                list.querySelectorAll('.btn-edit').forEach(button => {
                    button.addEventListener('click', (e) => handleEdit(e.currentTarget.dataset.id));
                });
                list.querySelectorAll('.btn-delete').forEach(button => {
                    button.addEventListener('click', (e) => handleDelete(e.currentTarget.dataset.id));
                });
            }
        };

        
        const fetchData = async () => {
            loadingMessage.classList.remove('hidden');
            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    console.log('Nenhum usuário logado para buscar dados.');
                    noDataMessage.classList.remove('hidden');
                    list.innerHTML = '';
                    return;
                }

                const { data, error } = await supabase
                    .from('financeiro')
                    .select('*')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Erro ao buscar dados:', error);
                    list.innerHTML = `<li class="text-center text-red-500">Erro ao carregar dados.</li>`;
                    noDataMessage.classList.add('hidden');
                } else {
                    renderListings(data);
                }
            } catch (err) {
                console.error('Erro inesperado:', err);
                list.innerHTML = `<li class="text-center text-red-500">Erro inesperado ao carregar dados.</li>`;
                noDataMessage.classList.add('hidden');
            } finally {
                loadingMessage.classList.add('hidden');
            }
        };

        
        const handleSubmit = async (e) => {
            e.preventDefault();

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('Você precisa estar logado para adicionar/atualizar lançamentos.');
                return;
            }

            const label = document.getElementById('label').value;
            const type = document.getElementById('type').value;
            const valor = parseFloat(document.getElementById('value').value);
            const mes = parseInt(document.getElementById('month').value);
            const ano = parseInt(document.getElementById('year').value);

            if (isNaN(valor) || isNaN(mes) || isNaN(ano)) {
                alert('Por favor, preencha todos os campos com valores válidos.');
                return;
            }

            const transaction = { label, tipo: type, valor, mes, ano, user_id: user.id };

            if (editingId) {
                // Update
                const { error } = await supabase
                    .from('financeiro')
                    .update(transaction)
                    .eq('id', editingId)
                    .eq('user_id', user.id);

                if (error) {
                    console.error('Erro ao atualizar:', error);
                } else {
                    alert('Lançamento atualizado com sucesso!');
                    editingId = null;
                    submitBtn.textContent = 'Adicionar Lançamento';
                    cancelBtn.classList.add('hidden');
                    form.reset();
                    fetchData();
                }
            } else {
                // Insert
                const { error } = await supabase
                    .from('financeiro')
                    .insert([transaction]);
                
                if (error) {
                    console.error('Erro ao adicionar:', error);
                } else {
                    alert('Lançamento adicionado com sucesso!');
                    form.reset();
                    fetchData();
                }
            }
        };

        
        const handleEdit = async (id) => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('Você precisa estar logado para editar lançamentos.');
                return;
            }

            const { data, error } = await supabase
                .from('financeiro')
                .select('*')
                .eq('id', id)
                .eq('user_id', user.id)
                .single();

            if (error) {
                console.error('Erro ao buscar item para edição:', error);
                return;
            }

            document.getElementById('label').value = data.label;
            document.getElementById('type').value = data.tipo;
            document.getElementById('value').value = data.valor;
            document.getElementById('month').value = data.mes;
            document.getElementById('year').value = data.ano;

            editingId = id;
            submitBtn.textContent = 'Atualizar Lançamento';
            cancelBtn.classList.remove('hidden');
        };

        
        const handleCancel = () => {
            editingId = null;
            form.reset();
            submitBtn.textContent = 'Adicionar Lançamento';
            cancelBtn.classList.add('hidden');
        };

        
        const handleDelete = async (id) => {
            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
                alert('Você precisa estar logado para deletar lançamentos.');
                return;
            }

            if (confirm('Tem certeza de que deseja deletar este lançamento?')) {
                const { error } = await supabase
                    .from('financeiro')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', user.id);

                if (error) {
                    console.error('Erro ao deletar:', error);
                } else {
                    alert('Lançamento deletado com sucesso!');
                    fetchData();
                }
            }
        };

        
        form.addEventListener('submit', handleSubmit);
        cancelBtn.addEventListener('click', handleCancel);

        
        window.addEventListener('load', async () => {
            await initializeSupabase();
            fetchData();

            supabase.auth.onAuthStateChange((event, session) => {
                if (session && session.user) {
                    console.log('Usuário está logado:', session.user);
                } else {
                    console.log('Usuário não está logado.');
                }
            });
        });

    </script>
</body>
</html>