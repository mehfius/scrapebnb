<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecione Suas Acomodações - Scrapebnb</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .confirm-dialog {
            transition: opacity 0.3s ease;
        }
        .amenity-btn .material-icons {
            vertical-align: bottom;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Selecione Suas Acomodações</h1>
                    <p class="text-sm text-gray-600 mt-1">Adicione os quartos que você gerencia para habilitar os relatórios e previsões da plataforma.</p>
                </div>
                <a href="/painel" class="flex-shrink-0 ml-4 flex items-center text-sm font-medium text-gray-600 hover:text-indigo-500">
                    <i class="material-icons mr-1">arrow_back</i>
                    Voltar ao Painel
                </a>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="py-10">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
            
            <!-- Passo 1: Adicionar Nova Acomodação -->
            <section id="add-room-section" class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Adicionar Nova Acomodação</h2>
                <p class="text-gray-600 mb-4">Selecione uma localização e, opcionalmente, as comodidades para buscar acomodações.</p>
                
                <div id="locations-container" class="flex flex-wrap gap-3"></div>

                <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Numero de quartos</label>
                        <div class="mt-1 w-fit flex items-center rounded-md border border-gray-300">
                            <button id="bedrooms-decrement-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded-l-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <i class="material-icons text-xl">remove</i>
                            </button>
                            <span id="bedrooms-value" class="w-12 text-center text-gray-800 font-medium border-l border-r border-gray-300">1</span>
                            <button id="bedrooms-increment-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded-r-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <i class="material-icons text-xl">add</i>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Maximo de hospedes</label>
                         <div class="mt-1 w-fit flex items-center rounded-md border border-gray-300">
                            <button id="adults-decrement-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded-l-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <i class="material-icons text-xl">remove</i>
                            </button>
                            <span id="adults-value" class="w-12 text-center text-gray-800 font-medium border-l border-r border-gray-300">2</span>
                            <button id="adults-increment-btn" class="p-2 text-gray-600 hover:bg-gray-100 rounded-r-md focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <i class="material-icons text-xl">add</i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Comodidades</h3>
                    <div id="amenities-container" class="flex flex-wrap gap-3">
                        <!-- Comodidades carregadas dinamicamente -->
                    </div>
                </div>
                <div class="mt-8">
                    <button id="search-button" class="w-full px-4 py-3 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-bold transition-colors disabled:bg-indigo-300 disabled:cursor-not-allowed">
                        Procurar Acomodações
                    </button>
                </div>
            </section>

            <!-- Passo 2: Selecionar Acomodação da Lista -->
            <section id="scraped-rooms-section" class="hidden bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Selecione uma acomodação para adicionar</h2>
                <p id="search-results-count" class="text-md text-gray-600 mb-4"></p>
                <div id="scraped-rooms-container" class="space-y-4"></div>
            </section>

            <!-- Seção Suas Acomodações Selecionadas -->
            <section>
                 <h2 class="text-xl font-bold text-gray-800 mb-4">Suas Acomodações Selecionadas</h2>
                <div id="rooms-container" class="bg-white rounded-lg shadow p-6 space-y-4">
                    <p id="rooms-loading-state" class="text-center text-gray-500">Carregando suas acomodações...</p>
                </div>
            </section>

        </div>
    </main>
    
    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmation-dialog" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center confirm-dialog">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm mx-auto">
            <h3 class="text-lg font-medium text-gray-900" id="confirm-title">Confirmar Ação</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500" id="confirm-message">Você tem certeza que deseja realizar esta ação?</p>
            </div>
            <div class="mt-4 flex justify-end space-x-3">
                <button id="cancel-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancelar</button>
                <button id="confirm-button" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase_auth_airbnb.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const roomsContainer = document.getElementById('rooms-container');
            const roomsLoadingState = document.getElementById('rooms-loading-state');
            const locationsContainer = document.getElementById('locations-container');
            const amenitiesContainer = document.getElementById('amenities-container');
            const scrapedRoomsSection = document.getElementById('scraped-rooms-section');
            const scrapedRoomsContainer = document.getElementById('scraped-rooms-container');
            const searchButton = document.getElementById('search-button');
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const confirmMessage = document.getElementById('confirm-message');
            let confirmButton = document.getElementById('confirm-button');
            let cancelButton = document.getElementById('cancel-button');

            // Counter elements for bedrooms
            const bedroomsValueSpan = document.getElementById('bedrooms-value');
            const bedroomsDecrementBtn = document.getElementById('bedrooms-decrement-btn');
            const bedroomsIncrementBtn = document.getElementById('bedrooms-increment-btn');

            // Counter elements for adults
            const adultsValueSpan = document.getElementById('adults-value');
            const adultsDecrementBtn = document.getElementById('adults-decrement-btn');
            const adultsIncrementBtn = document.getElementById('adults-increment-btn');

            let currentUser = null;
            let userRoomIds = new Set();
            let selectedLocation = null;
            let bedroomCount = 1;
            let adultCount = 2;


            const loadAmenities = async () => {
                const { data: amenities, error } = await supabase.from('amenities').select('label, code, icon').eq('hide', false);
                
                if (error) {
                    console.error('Erro ao buscar comodidades:', error);
                    amenitiesContainer.innerHTML = '<p class="text-red-500">Não foi possível carregar as comodidades.</p>';
                    return;
                }

                amenitiesContainer.innerHTML = '';
                amenities.forEach(amenity => {
                    const button = document.createElement('button');
                    button.dataset.amenityId = amenity.code;
                    button.className = 'amenity-btn flex items-center px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 font-medium transition-colors';
                    button.innerHTML = `
                        <i class="material-icons mr-2">${amenity.icon}</i>
                        <span>${amenity.label}</span>
                    `;
                    amenitiesContainer.appendChild(button);
                });
            };
            
            amenitiesContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.amenity-btn');
                if (button) {
                    button.classList.toggle('bg-indigo-600');
                    button.classList.toggle('text-white');
                    button.classList.toggle('bg-gray-200');
                    button.classList.toggle('text-gray-800');
                }
            });

            const showToast = (message, isError = false) => {
                toastMessage.textContent = message;
                toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            };
            
            const showConfirmation = (message) => {
                return new Promise(resolve => {
                    confirmMessage.textContent = message;
                    confirmationDialog.classList.remove('hidden');

                    const newConfirmButton = confirmButton.cloneNode(true);
                    confirmButton.parentNode.replaceChild(newConfirmButton, confirmButton);
                    confirmButton = newConfirmButton;
                    
                    const newCancelButton = cancelButton.cloneNode(true);
                    cancelButton.parentNode.replaceChild(newCancelButton, cancelButton);
                    cancelButton = newCancelButton;

                    confirmButton.onclick = () => {
                        confirmationDialog.classList.add('hidden');
                        resolve(true);
                    };

                    cancelButton.onclick = () => {
                        confirmationDialog.classList.add('hidden');
                        resolve(false);
                    };
                });
            };

            const initUser = async () => {
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
            };

            const addRoomToUser = async (buttonElement) => {
                if (!currentUser) {
                    showToast("Você precisa estar logado para adicionar uma acomodação.", true);
                    return;
                }
                
                const roomId = buttonElement.dataset.roomId;
                const pictureUrl = buttonElement.dataset.pictureUrl;

                if (userRoomIds.has(String(roomId))) {
                    showToast("Esta acomodação já está na sua lista.", true);
                    return;
                }

                const { error } = await supabase
                    .from('users_rooms')
                    .insert([{ user_id: currentUser.id, room: roomId, url: pictureUrl }]);

                if (error) {
                    console.error("Erro ao adicionar acomodação:", error);
                    showToast(`Erro ao adicionar acomodação: ${error.message}`, true);
                } else {
                    showToast(`Acomodação ${roomId} adicionada com sucesso!`);
                    await fetchRooms();

                    buttonElement.textContent = 'Remover';
                    buttonElement.classList.remove('add-room-btn', 'bg-green-500', 'hover:bg-green-600');
                    buttonElement.classList.add('remove-room-btn-search', 'bg-red-500', 'hover:bg-red-600');
                }
            };
            
            const removeRoomFromUser = async (buttonElement) => {
                if (!currentUser) {
                    showToast("Você precisa estar logado.", true);
                    return;
                }
                
                const roomId = buttonElement.dataset.roomId;
                const confirmed = await showConfirmation(`Tem certeza de que deseja remover a acomodação ${roomId}?`);
                if (confirmed) {
                    const { error } = await supabase
                        .from('users_rooms')
                        .delete()
                        .match({ user_id: currentUser.id, room: roomId });

                    if (error) {
                        console.error("Erro ao remover acomodação:", error);
                        showToast(`Erro ao remover acomodação: ${error.message}`, true);
                    } else {
                        showToast(`Acomodação ${roomId} removida com sucesso!`);
                        await fetchRooms();

                        const searchButton = document.querySelector(`.remove-room-btn-search[data-room-id='${roomId}']`);
                        if (searchButton) {
                            searchButton.textContent = 'Adicionar';
                            searchButton.classList.remove('remove-room-btn-search', 'bg-red-500', 'hover:bg-red-600');
                            searchButton.classList.add('add-room-btn', 'bg-green-500', 'hover:bg-green-600');
                        }
                    }
                }
            };

            const fetchScrapedRooms = async (locationTag, locationLabel, amenities, minBedrooms, adults) => {
                scrapedRoomsSection.classList.remove('hidden');
                const searchResultsCount = document.getElementById('search-results-count');
                searchResultsCount.textContent = ''; // Clear previous count while loading

                scrapedRoomsContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center p-8">
                        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="text-center text-gray-500 mt-4">Buscando acomodações em ${locationLabel}${amenities.length > 0 ? ' com as comodidades selecionadas' : ''}...</p>
                    </div>`;
                scrapedRoomsContainer.className = 'space-y-4';

                const apiBody = { 
                    location: locationTag, 
                    adults: adults, 
                    min_bedrooms: minBedrooms 
                };
                if (amenities && amenities.length > 0) {
                    apiBody.amenities = amenities;
                }

                try {
                    const response = await fetch('/api/airbnb/search', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(apiBody)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    scrapedRoomsContainer.innerHTML = '';

                    if (result.room && result.picture && result.room.length > 0) {
                        const count = result.room.length;
                        if (count === 1) {
                            searchResultsCount.textContent = '1 acomodação encontrada.';
                        } else {
                            searchResultsCount.textContent = `${count} acomodações encontradas.`;
                        }

                        scrapedRoomsContainer.className = 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6';
                        
                        result.room.forEach((roomId, index) => {
                            const pictureUrl = result.picture[index];
                            const isAdded = userRoomIds.has(String(roomId));
                            const card = document.createElement('div');
                            card.className = 'bg-white rounded-lg shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300';
                            
                            const buttonHtml = isAdded
                                ? `<button data-room-id="${roomId}" class="remove-room-btn-search w-full px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 font-medium transition-colors">Remover</button>`
                                : `<button data-room-id="${roomId}" data-picture-url="${pictureUrl}" class="add-room-btn w-full px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 font-medium transition-colors">Adicionar</button>`;

                            card.innerHTML = `
                                <img src="${pictureUrl}" alt="Foto da acomodação ${roomId}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/4a5568?text=Imagem+Indispon%C3%ADvel';">
                                <div class="p-4 flex flex-col items-center">
                                    <p class="text-sm text-gray-600 mb-3">ID: ${roomId}</p>
                                    ${buttonHtml}
                                </div>`;
                            scrapedRoomsContainer.appendChild(card);
                        });

                    } else {
                        searchResultsCount.textContent = 'Nenhuma acomodação encontrada.';
                        scrapedRoomsContainer.className = 'space-y-4';
                        scrapedRoomsContainer.innerHTML = `<p class="text-center text-gray-600">Não encontramos resultados para esta combinação de filtros.</p>`;
                    }
                } catch (error) {
                    console.error("Falha ao buscar acomodações da API:", error);
                    searchResultsCount.textContent = '';
                    scrapedRoomsContainer.className = 'space-y-4';
                    scrapedRoomsContainer.innerHTML = `<p class="text-center text-red-500">Erro ao buscar acomodações. Tente novamente.</p>`;
                }
            };

            const loadLocations = async () => {
                const { data: locations, error } = await supabase.from('locations').select('id, label, tag');
                if (error) return;
                
                locationsContainer.innerHTML = '';
                locations.forEach(location => {
                    const button = document.createElement('button');
                    button.className = 'location-btn px-4 py-2 bg-indigo-100 text-indigo-700 rounded-md hover:bg-indigo-200 font-medium transition-colors';
                    button.textContent = location.label;
                    button.value = location.tag;
                    button.dataset.label = location.label;

                    button.addEventListener('click', (e) => {
                        locationsContainer.querySelectorAll('.location-btn').forEach(btn => {
                            btn.classList.remove('bg-indigo-600', 'text-white');
                            btn.classList.add('bg-indigo-100', 'text-indigo-700');
                        });
                        e.target.classList.add('bg-indigo-600', 'text-white');
                        e.target.classList.remove('bg-indigo-100', 'text-indigo-700');
                        
                        selectedLocation = { tag: e.target.value, label: e.target.dataset.label };
                    });
                    locationsContainer.appendChild(button);
                });
            };

            const fetchRooms = async () => {
                if (!currentUser) return;
                
                const { data: rooms, error } = await supabase.from('users_rooms').select('room::text, url').eq('user_id', currentUser.id);
                
                if(roomsLoadingState) roomsLoadingState.remove();

                roomsContainer.innerHTML = '';
                if (error) return;

                userRoomIds = new Set(rooms.map(r => String(r.room)));

                if (rooms.length === 0) {
                    roomsContainer.innerHTML = `<p class="text-center text-gray-600">Você ainda não adicionou nenhuma acomodação.</p>`;
                    return;
                }
                const roomList = document.createElement('ul');
                roomList.className = 'divide-y divide-gray-200';
                rooms.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'py-4 flex items-center justify-between';
                    li.innerHTML = `
                        <div class="flex items-center">
                             <img src="${item.url}" alt="Foto da acomodação ${item.room}" class="w-16 h-16 object-cover rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/4a5568?text=Sem+Foto';">
                            <div class="flex items-center">
                               <i class="material-icons text-gray-500 mr-2">hotel</i>
                               <span class="text-lg text-gray-800">${item.room}</span>
                            </div>
                        </div>
                        <button data-room-id="${item.room}" class="remove-room-btn p-2 rounded-full text-gray-500 hover:bg-red-100 hover:text-red-600 transition-colors">
                            <i class="material-icons">delete</i>
                        </button>
                    `;
                    roomList.appendChild(li);
                });
                roomsContainer.appendChild(roomList);
                
                document.querySelectorAll('.remove-room-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        removeRoomFromUser(e.target.closest('[data-room-id]'));
                    });
                });
            };
            
            // Event Listeners for counters
            bedroomsDecrementBtn.addEventListener('click', () => {
                if (bedroomCount > 1) {
                    bedroomCount--;
                    bedroomsValueSpan.textContent = bedroomCount;
                }
            });
            bedroomsIncrementBtn.addEventListener('click', () => {
                bedroomCount++;
                bedroomsValueSpan.textContent = bedroomCount;
            });
            adultsDecrementBtn.addEventListener('click', () => {
                if (adultCount > 1) {
                    adultCount--;
                    adultsValueSpan.textContent = adultCount;
                }
            });
            adultsIncrementBtn.addEventListener('click', () => {
                adultCount++;
                adultsValueSpan.textContent = adultCount;
            });

            searchButton.addEventListener('click', () => {
                if (!selectedLocation) {
                    showToast("Por favor, selecione uma localização primeiro.", true);
                    return;
                }

                const minBedrooms = bedroomCount.toString();
                const adults = adultCount.toString();

                const selectedAmenities = [];
                const activeAmenityButtons = amenitiesContainer.querySelectorAll('.bg-indigo-600');
                activeAmenityButtons.forEach(btn => {
                    selectedAmenities.push(Number(btn.dataset.amenityId));
                });

                fetchScrapedRooms(selectedLocation.tag, selectedLocation.label, selectedAmenities, minBedrooms, adults);
            });

            scrapedRoomsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;

                if (button.classList.contains('add-room-btn')) {
                    addRoomToUser(button);
                } else if (button.classList.contains('remove-room-btn-search')) {
                    removeRoomFromUser(button);
                }
            });

            const init = async () => {       
                await initUser();
                await loadAmenities();
                await loadLocations();
                await fetchRooms();
            };

            init();
        });
    </script>
</body>
</html>

