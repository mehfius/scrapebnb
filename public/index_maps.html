<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Anúncios no Mapa</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- External Supabase Auth Script -->
    <script src="https://scrapebnb.vercel.app/js/supabase_auth_airbnb.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #map-container {
            flex-grow: 1; /* Make map container fill remaining space */
            min-height: 0; /* Important for flex-grow in some browsers */
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        select, input[type="date"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem; /* 12px */
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 256px !important; /* 16rem */
        }
        .leaflet-popup-tip-container {
            display: none; /* Hide default popup arrow */
        }
    </style>
</head>
<body>

    <!-- Header Section -->
    <header id="app-header" class="bg-white shadow-md p-4 z-10 flex flex-wrap items-center justify-between gap-4">
        <!-- Header controls will be injected here by JavaScript -->
    </header>

    <!-- Map Section -->
    <main id="map-container" class="relative">
        <div id="map" class="z-0"></div>
        <div id="map-loader" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-20">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                <p class="mt-4 text-gray-700">Carregando dados...</p>
            </div>
        </div>
    </main>

    <script type="module">
        // --- DOM Elements ---
        const eHeader = document.getElementById('app-header');
        const eMapLoader = document.getElementById('map-loader');
        
        // --- Map Variables ---
        let map = null;
        let markersLayer = null;

        // --- Element Creation ---
        const createElement = (tag, options = {}) => {
            const el = document.createElement(tag);
            if (options.id) el.id = options.id;
            if (options.className) el.className = options.className;
            if (options.innerHTML) el.innerHTML = options.innerHTML;
            if (options.type) el.type = options.type;
            if (options.value) el.value = options.value;
            return el;
        };

        const createSelectOption = (value, text) => {
            const opt = createElement('option', { innerHTML: text });
            opt.value = value;
            return opt;
        };

        // --- UI Initialization ---
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

        const baseInputClasses = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5';
        const baseButtonClasses = 'cursor-pointer p-2.5 rounded-lg hover:bg-gray-100 transition-colors';

        const eDateLabel = createElement('label', { className: 'font-semibold text-lg whitespace-nowrap order-1 sm:order-1' });
        const eRooms = createElement('button', { innerHTML: 'holiday_village', className: `material-symbols-outlined ${baseButtonClasses} order-2 sm:order-2` });
        const airbnb = createElement('a', { innerHTML: 'Ver Anúncio no Airbnb', className: `bg-red-500 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-red-600 transition-colors text-sm whitespace-nowrap order-3 sm:order-3` });
        const eCalendar = createElement('input', { id: 'checkin-calendar', type: 'date', value: tomorrowFormatted, className: `${baseInputClasses} order-4 sm:order-4` });
        const eJobSelect = createElement('select', { id: 'job-select', className: `${baseInputClasses} order-5 sm:order-5` });
        const eSortSelect = createElement('select', { id: 'sort-select', className: `${baseInputClasses} order-6 sm:order-6` });
        const eConfigJob = createElement('button', { innerHTML: 'settings', className: `material-symbols-outlined ${baseButtonClasses} order-7 sm:order-7` });
        
        eHeader.append(eDateLabel, eRooms, airbnb, eCalendar, eJobSelect, eSortSelect, eConfigJob);

        const sortOptions = [
            { value: 'position', label: 'Ordernar por Posição' },
            { value: 'price', label: 'Ordernar por Preço' }
        ];
        sortOptions.forEach(option => eSortSelect.appendChild(createSelectOption(option.value, option.label)));

        let jobs = [];

        const updateDateLabel = (dateString) => {
            const date = new Date(dateString + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            eDateLabel.innerHTML = date.toLocaleDateString('pt-BR', options);
        };

        const updateViewJobLink = () => {
            const selectedJobId = eJobSelect.value;
            const job = jobs.find(j => j.id == selectedJobId);
            if (job) {
                const checkinDateString = eCalendar.value;
                const checkoutDate = new Date(checkinDateString + 'T00:00:00');
                checkoutDate.setDate(checkoutDate.getDate() + 3);
                const checkoutDateString = checkoutDate.toISOString().split('T')[0];
                const amenitiesQuery = (job.amenities && job.amenities.length > 0) ? job.amenities.map(a => `&amenities%5B%5D=${a}`).join('') : '';
                const priceQuery = job.price_max ? `&price_max=${job.price_max}&price_filter_input_type=${job.price_filter_input_type}` : '';
                const url = `https://www.airbnb.com.br/s/${job.tag}/homes?adults=${job.adults}&min_bedrooms=${job.min_bedrooms}&check_in=${checkinDateString}&check_out=${checkoutDateString}${amenitiesQuery}${priceQuery}`;
                airbnb.href = url;
                airbnb.target = '_blank';
            } else {
                airbnb.href = '#';
                airbnb.target = '';
            }
        };

        const populateJobSelect = async () => {
            try {
                const response = await fetch(`${globalThis.auth.SUPABASE_URL}/rest/v1/jobs?select=*`, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                jobs = await response.json();
                
                eJobSelect.innerHTML = '';
                let latestJobId = null;

                if (jobs.length > 0) {
                    jobs.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    latestJobId = jobs[jobs.length - 1].id;

                    jobs.forEach(job => {
                        const label = `${job.id} | ${job.label || 'N/A'} | Adultos: ${job.adults || 'N/A'} | Quartos: ${job.min_bedrooms || 'N/A'}`;
                        eJobSelect.appendChild(createSelectOption(job.id, label));
                    });
                    eJobSelect.value = latestJobId;
                }
                return latestJobId;
            } catch (error) {
                console.error("Failed to populate jobs:", error);
                return null;
            }
        };

        const fetchDataForDate = async (checkinDate, jobId, sortBy) => {
            eMapLoader.classList.remove('hidden');

            let url = `${globalThis.auth.SUPABASE_URL}/rest/v1/frontend?select=id,name,gold,room_image_array,position,title,host_image,favorite,superhost,reference_label,average_price_per_night,tagged,latitude,longitude&checkin=eq.${checkinDate}&limit=200`;
            if (jobId) url += `&job=eq.${jobId}`;
            url += sortBy === 'price' ? `&order=average_price_per_night` : `&order=position`;

            try {
                const response = await fetch(url, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                markersLayer.clearLayers();
                const locationsWithData = data.filter(item => item.latitude && item.longitude);

                if (locationsWithData.length > 0) {
                    const markerBounds = [];
                    locationsWithData.forEach(item => {
                        const marker = L.marker([item.latitude, item.longitude]);
                        
                        const imageUrl = (item.room_image_array && item.room_image_array.length > 0) ? item.room_image_array[0] : item.host_image;
                        const price = item.average_price_per_night ? `R$ ${item.average_price_per_night}` : 'N/A';
                        
                        const popupContent = `
                            <div class="w-64">
                                <img src="${imageUrl}" class="w-full h-32 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=Imagem';">
                                <div class="p-3">
                                    <h3 class="font-bold text-sm truncate" title="${item.title}">${item.title}</h3>
                                    <p class="text-md font-semibold mt-1">${price}</p>
                                </div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        
                        marker.on('mouseover', function () { this.openPopup(); });
                        marker.on('mouseout', function () { this.closePopup(); });

                        markersLayer.addLayer(marker);
                        markerBounds.push([item.latitude, item.longitude]);
                    });
                    map.fitBounds(markerBounds, { padding: [50, 50] });
                } else {
                    map.setView([-14.2350, -51.9253], 4); // Reset to Brazil view
                }

            } catch (error) {
                console.error("Failed to fetch data:", error);
                markersLayer.clearLayers();
            } finally {
                eMapLoader.classList.add('hidden');
            }
        };

        const handleDateChange = () => {
            const newDate = eCalendar.value;
            fetchDataForDate(newDate, eJobSelect.value, eSortSelect.value);
            updateViewJobLink();
            updateDateLabel(newDate);
        };

        eCalendar.addEventListener('change', handleDateChange);
        eJobSelect.addEventListener('change', () => {
            fetchDataForDate(eCalendar.value, eJobSelect.value, eSortSelect.value);
            updateViewJobLink();
        });
        eSortSelect.addEventListener('change', () => {
            fetchDataForDate(eCalendar.value, eJobSelect.value, eSortSelect.value);
        });

        eRooms.addEventListener('click', () => console.log("Rooms button clicked."));
        eConfigJob.addEventListener('click', () => console.log("Config Job button clicked."));

        document.addEventListener('keydown', (event) => {
            if (document.activeElement === eCalendar || document.activeElement === eJobSelect || document.activeElement === eSortSelect) return;
            
            const currentDate = new Date(eCalendar.value + 'T00:00:00');
            let dateChanged = false;
            if (event.key === 'ArrowLeft') {
                currentDate.setDate(currentDate.getDate() - 1);
                dateChanged = true;
            } else if (event.key === 'ArrowRight') {
                currentDate.setDate(currentDate.getDate() + 1);
                dateChanged = true;
            }
            if (dateChanged) {
                eCalendar.value = currentDate.toISOString().split('T')[0];
                handleDateChange();
            }
        });

        const initializeApp = async () => {
            if (typeof globalThis.auth === 'undefined' || !globalThis.auth.SUPABASE_URL) {
                setTimeout(initializeApp, 1000);
                return;
            }

            map = L.map('map').setView([-14.2350, -51.9253], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            const initialJobId = await populateJobSelect();
            fetchDataForDate(tomorrowFormatted, initialJobId, eSortSelect.value);
            updateViewJobLink();
            updateDateLabel(tomorrowFormatted);
        };

        initializeApp();

    </script>
</body>
</html>
