<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Anúncios no Mapa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://scrapebnb.vercel.app/js/supabase_auth_airbnb.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #map-container {
            flex-grow: 1;
            min-height: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.is-open {
            transform: translateX(0);
        }
        .custom-select-options {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .leaflet-marker-icon {
            transition: opacity 0.3s ease-in-out;
        }
        .tagged-highlight {
            border-color: #facc15; /* Tailwind amber-400 */
            box-shadow: 0 0 8px 2px rgba(250, 204, 21, 0.6);
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            display: none;
            -webkit-appearance: none;
        }
    </style>
</head>
<body class="flex flex-col">

    <header id="app-header" class="bg-white shadow-md p-4 z-40 flex items-center justify-between gap-4 flex-shrink-0">
    </header>

    <div class="relative flex-grow min-h-0">
        <aside id="sidebar" class="absolute top-0 left-0 h-full w-96 bg-white shadow-lg transform -translate-x-full z-30 overflow-y-auto">
            <div id="sidebar-content" class="p-6">
                <div class="text-center text-gray-500 mt-8">
                    <span class="material-symbols-outlined text-6xl">real_estate_agent</span>
                    <p class="mt-4">Clique em um anúncio no mapa para ver os detalhes aqui.</p>
                </div>
            </div>
        </aside>

        <main id="map-container" class="relative h-full w-full">
            <div id="map" class="z-10"></div>
            <div id="map-loader" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-20">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                    <p class="mt-4 text-gray-700">Carregando dados...</p>
                </div>
            </div>
        </main>

        <aside id="listing-sidebar" class="absolute top-0 right-0 h-full w-48 bg-white shadow-lg z-30 overflow-y-auto">
            <div class="p-4 border-b">
                 <h2 class="text-xl font-bold text-gray-800">Acomodações</h2>
            </div>
            <div id="listing-sidebar-content" class="p-2 space-y-2">
            </div>
        </aside>
    </div>

    <script type="module">
        const eHeader = document.getElementById('app-header');
        const eMapLoader = document.getElementById('map-loader');
        const eSidebar = document.getElementById('sidebar');
        const eSidebarContent = document.getElementById('sidebar-content');
        const eListingSidebarContent = document.getElementById('listing-sidebar-content');
        
        let map = null;
        let markersLayer = null;
        let jobs = [];
        let selectedJobId = null;
        let currentLocations = [];

        delete L.Icon.Default.prototype._getIconUrl;
        L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
            iconSize:     [13, 21],
            iconAnchor:   [6, 21],
            popupAnchor: [1, -20],
            shadowSize:   [21, 21]
        });


        const createElement = (tag, options = {}) => {
            const el = document.createElement(tag);
            if (options.id) el.id = options.id;
            if (options.className) el.className = options.className;
            if (options.innerHTML) el.innerHTML = options.innerHTML;
            if (options.type) el.type = options.type;
            if (options.value) el.value = options.value;
            if (options.dataset) {
                for (const key in options.dataset) {
                    el.dataset[key] = options.dataset[key];
                }
            }
            return el;
        };

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

        const baseInputClasses = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm focus:ring-blue-500 focus:border-blue-500 block p-2.5';
        
        const eLogo = createElement('img', { className: 'w-[200px] h-auto' });
        eLogo.src = 'https://scrapebnb.vercel.app/img/scrapebnb.jpg';
        const airbnb = createElement('a', { innerHTML: 'Ver no Airbnb', className: `bg-red-500 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-red-600 transition-colors text-sm whitespace-nowrap` });
        
        const eDateControlContainer = createElement('div', { className: 'flex items-center border border-gray-300 rounded-lg overflow-hidden' });
        const ePrevDayBtn = createElement('button', { id: 'prev-day-btn', className: 'py-[9px] px-2.5 bg-gray-50 hover:bg-gray-100 transition-colors border-r border-gray-300' });
        ePrevDayBtn.innerHTML = `<span class="material-symbols-outlined text-gray-600 text-base">chevron_left</span>`;
        const eCalendar = createElement('input', { id: 'checkin-calendar', type: 'date', value: tomorrowFormatted, className: `bg-gray-50 text-gray-900 text-sm focus:ring-0 block p-2.5 w-[150px]` });
        const eNextDayBtn = createElement('button', { id: 'next-day-btn', className: 'py-[9px] px-2.5 bg-gray-50 hover:bg-gray-100 transition-colors border-l border-gray-300' });
        eNextDayBtn.innerHTML = `<span class="material-symbols-outlined text-gray-600 text-base">chevron_right</span>`;
        eDateControlContainer.append(ePrevDayBtn, eCalendar, eNextDayBtn);

        const eJobSelectContainer = createElement('div', { id: 'job-select-container', className: 'relative' });
        const eJobSelectButton = createElement('button', { id: 'job-select-button', className: `${baseInputClasses} flex items-center justify-between text-left w-auto rounded-lg` });
        const eJobSelectButtonText = createElement('span', { innerHTML: 'Carregando jobs...' });
        const eJobSelectButtonIcon = createElement('span', { className: 'material-symbols-outlined text-gray-500 ml-2', innerHTML: 'expand_more' });
        eJobSelectButton.append(eJobSelectButtonText, eJobSelectButtonIcon);

        const eJobSelectOptions = createElement('div', { id: 'job-select-options', className: 'custom-select-options absolute mt-1 w-max max-w-md bg-white border border-gray-300 rounded-lg shadow-lg z-50 opacity-0 transform scale-95 pointer-events-none' });
        eJobSelectContainer.append(eJobSelectButton, eJobSelectOptions);

        eJobSelectButton.addEventListener('click', (e) => {
            e.stopPropagation();
            const isOpen = eJobSelectOptions.classList.contains('opacity-100');
            if (isOpen) {
                eJobSelectOptions.classList.remove('opacity-100', 'scale-100');
                eJobSelectOptions.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            } else {
                eJobSelectOptions.classList.remove('opacity-0', 'scale-95', 'pointer-events-none');
                eJobSelectOptions.classList.add('opacity-100', 'scale-100');
            }
        });

        window.addEventListener('click', () => {
             if (eJobSelectOptions.classList.contains('opacity-100')) {
                eJobSelectOptions.classList.remove('opacity-100', 'scale-100');
                eJobSelectOptions.classList.add('opacity-0', 'scale-95', 'pointer-events-none');
            }
        });
        
        const eHeaderLeft = createElement('div', { className: 'flex items-center gap-4' });
        const eHeaderCenter = createElement('div', { className: 'flex items-center gap-2' });

        eHeaderLeft.append(eLogo);
        eHeaderCenter.append(eDateControlContainer, eJobSelectContainer);
        eHeader.append(eHeaderLeft, eHeaderCenter, airbnb);

        const resetHighlights = () => {
            currentLocations.forEach(loc => {
                if (loc.marker) {
                    loc.marker.setOpacity(1.0);
                }
            });
        };

        const closeSidebar = () => {
            eSidebar.classList.remove('is-open');
            resetHighlights();
        };

        const selectItem = (selectedItem) => {
            currentLocations.forEach(loc => {
                if (loc.marker) {
                    const isSelected = loc.id === selectedItem.id;
                    loc.marker.setOpacity(isSelected ? 1.0 : 0.5);
                }
            });
            openSidebar(selectedItem);
            map.panTo([selectedItem.latitude, selectedItem.longitude]);
        };

        const openSidebar = (item) => {
            const imageUrl = (item.room_image_array && item.room_image_array.length > 0) ? item.room_image_array[0] : item.host_image;
            const price = item.average_price_per_night ? `R$ ${item.average_price_per_night}` : 'N/A';

            eSidebarContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Detalhes do Anúncio</h2>
                    <button id="sidebar-close-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <img src="${imageUrl}" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x192/cccccc/ffffff?text=Imagem';">
                    <h3 class="font-bold text-lg text-gray-900">${item.title}</h3>
                    <p class="text-2xl font-semibold text-gray-800">${price} <span class="text-base font-normal text-gray-600">/ noite</span></p>
                    <div class="flex justify-start items-center gap-6 text-gray-600 border-t pt-4">
                         <div class="flex items-center gap-1.5" title="Favorito">
                             <span class="material-symbols-outlined text-lg ${item.favorite ? 'text-red-500' : 'text-gray-400'}">favorite</span>
                             <span class="text-sm font-medium">Favorito</span>
                         </div>
                         <div class="flex items-center gap-1.5" title="Superhost">
                             <span class="material-symbols-outlined text-lg ${item.superhost ? 'text-yellow-500' : 'text-gray-400'}">star</span>
                             <span class="text-sm font-medium">Superhost</span>
                         </div>
                         <div class="flex items-center gap-1.5" title="Selo Gold">
                             <span class="material-symbols-outlined text-lg ${item.gold ? 'text-amber-400' : 'text-gray-400'}">beenhere</span>
                             <span class="text-sm font-medium">Gold</span>
                         </div>
                    </div>
                    <a href="https://www.airbnb.com.br/rooms/${item.room}" target="_blank" class="block w-full text-center bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-all duration-300 shadow-lg hover:shadow-xl mt-2">Ver no Airbnb</a>
                </div>
            `;
            document.getElementById('sidebar-close-btn').addEventListener('click', closeSidebar);
            
            if (!eSidebar.classList.contains('is-open')) {
                eSidebar.classList.add('is-open');
            }
        };

        const updateViewJobLink = () => {
            const job = jobs.find(j => j.id == selectedJobId);
            if (job) {
                const checkinDateString = eCalendar.value;
                const checkoutDate = new Date(checkinDateString + 'T00:00:00');
                checkoutDate.setDate(checkoutDate.getDate() + 3);
                const checkoutDateString = checkoutDate.toISOString().split('T')[0];
                const amenitiesQuery = (job.amenities && job.amenities.length > 0) ? job.amenities.map(a => `&amenities%5B%5D=${a}`).join('') : '';
                const priceQuery = job.price_max ? `&price_max=${job.price_max}&price_filter_input_type=${job.price_filter_input_type}` : '';
                const url = `https://www.airbnb.com.br/s/${job.tag}/homes?adults=${job.adults}&min_bedrooms=${job.min_bedrooms}&check_in=${checkinDateString}&check_out=${checkoutDateString}${amenitiesQuery}${priceQuery}`;
                airbnb.href = url;
                airbnb.target = '_blank';
            } else {
                airbnb.href = '#';
                airbnb.target = '';
            }
        };

        const populateJobSelect = async () => {
            try {
                const response = await fetch(`${globalThis.auth.SUPABASE_URL}/rest/v1/jobs?select=*`, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                jobs = await response.json();
                
                eJobSelectOptions.innerHTML = '';
                let latestJobId = null;

                if (jobs.length > 0) {
                    jobs.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    latestJobId = jobs[jobs.length - 1].id;

                    jobs.forEach(job => {
                        const label = `${job.id} | ${job.label || 'N/A'} | Adultos: ${job.adults || 'N/A'} | Quartos: ${job.min_bedrooms || 'N/A'}`;
                        const optionEl = createElement('a', { 
                            className: 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer',
                            innerHTML: label,
                            dataset: { value: job.id }
                        });
                        optionEl.addEventListener('click', () => {
                            selectedJobId = job.id;
                            eJobSelectButtonText.innerHTML = label;
                            fetchDataForDate(eCalendar.value, selectedJobId, true);
                            updateViewJobLink();
                        });
                        eJobSelectOptions.appendChild(optionEl);
                    });
                    
                    selectedJobId = latestJobId;
                    const selectedJob = jobs.find(j => j.id == selectedJobId);
                    eJobSelectButtonText.innerHTML = `${selectedJob.id} | ${selectedJob.label || 'N/A'} | Adultos: ${selectedJob.adults || 'N/A'} | Quartos: ${selectedJob.min_bedrooms || 'N/A'}`;
                } else {
                    eJobSelectButtonText.innerHTML = 'Nenhum job encontrado';
                }
                return latestJobId;
            } catch (error) {
                console.error("Failed to populate jobs:", error);
                eJobSelectButtonText.innerHTML = 'Erro ao carregar jobs';
                return null;
            }
        };

        const fetchDataForDate = async (checkinDate, jobId, fitBounds = true) => {
            eMapLoader.classList.remove('hidden');
            closeSidebar();

            let url = `${globalThis.auth.SUPABASE_URL}/rest/v1/frontend?select=id,name,gold,room_image_array,position,title,host_image,favorite,superhost,reference_label,average_price_per_night,tagged,latitude,longitude,host,room&checkin=eq.${checkinDate}&limit=200&order=position`;
            if (jobId) url += `&job=eq.${jobId}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                markersLayer.clearLayers();
                eListingSidebarContent.innerHTML = ''; 
                currentLocations = [];

                const locationsWithData = data.filter(item => item.latitude && item.longitude);

                if (locationsWithData.length > 0) {
                    const markerBounds = [];
                    locationsWithData.forEach(item => {
                        const marker = L.marker([item.latitude, item.longitude]);
                        
                        item.marker = marker;
                        currentLocations.push(item);

                        marker.on('click', (e) => {
                            L.DomEvent.stopPropagation(e);
                            selectItem(item);
                        });
                        markersLayer.addLayer(marker);
                        markerBounds.push([item.latitude, item.longitude]);

                        const listItem = document.createElement('div');
                        let baseClasses = 'p-2 rounded-lg border cursor-pointer hover:bg-gray-100 hover:shadow-md transition-all';
                        if (item.tagged) {
                            baseClasses += ' tagged-highlight';
                        }
                        listItem.className = baseClasses;
                        listItem.innerHTML = `
                            <h4 class="font-semibold text-gray-800 text-xs truncate">${item.title}</h4>
                            <p class="text-gray-500 text-xs truncate mt-1">${item.name || ''}</p>
                            <div class="flex justify-between items-center mt-2">
                                <div class="flex items-center gap-3 text-gray-500">
                                    <span class="material-symbols-outlined text-base ${item.favorite ? 'text-red-400' : 'text-gray-300'}" title="Favorito">favorite</span>
                                    <span class="material-symbols-outlined text-base ${item.superhost ? 'text-yellow-400' : 'text-gray-300'}" title="Superhost">star</span>
                                    <span class="material-symbols-outlined text-base ${item.gold ? 'text-amber-300' : 'text-gray-300'}" title="Selo Gold">beenhere</span>
                                </div>
                                <p class="font-bold text-gray-900 text-sm">R$ ${item.average_price_per_night || 'N/A'}</p>
                            </div>
                        `;
                        listItem.addEventListener('click', () => {
                            selectItem(item);
                        });
                        eListingSidebarContent.appendChild(listItem);
                    });
                    
                    if (fitBounds) {
                        map.fitBounds(markerBounds, { padding: [50, 50] });
                    }
                } else {
                    eListingSidebarContent.innerHTML = '<p class="text-center text-gray-500 mt-8">Nenhuma acomodação encontrada.</p>';
                    if (fitBounds) {
                        map.setView([-14.2350, -51.9253], 4);
                    }
                }

            } catch (error) {
                console.error("Failed to fetch data:", error);
                markersLayer.clearLayers();
                eListingSidebarContent.innerHTML = '<p class="text-center text-red-500 mt-8">Erro ao carregar dados.</p>';
            } finally {
                eMapLoader.classList.add('hidden');
            }
        };

        const handleDateChange = () => {
            const newDate = eCalendar.value;
            fetchDataForDate(newDate, selectedJobId, false);
            updateViewJobLink();
        };

        eCalendar.addEventListener('change', handleDateChange);

        ePrevDayBtn.addEventListener('click', () => {
            const currentDate = new Date(eCalendar.value + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() - 1);
            eCalendar.value = currentDate.toISOString().split('T')[0];
            handleDateChange();
        });

        eNextDayBtn.addEventListener('click', () => {
            const currentDate = new Date(eCalendar.value + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() + 1);
            eCalendar.value = currentDate.toISOString().split('T')[0];
            handleDateChange();
        });

        const initializeApp = async () => {
            if (typeof globalThis.auth === 'undefined' || !globalThis.auth.SUPABASE_URL) {
                setTimeout(initializeApp, 1000);
                return;
            }

            map = L.map('map').setView([-14.2350, -51.9253], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('click', closeSidebar);

            const initialJobId = await populateJobSelect();
            if(initialJobId) {
                fetchDataForDate(tomorrowFormatted, initialJobId, true);
                updateViewJobLink();
            }
        };

        initializeApp();

    </script>
</body>
</html>
