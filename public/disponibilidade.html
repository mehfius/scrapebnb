<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Disponibilidade - Scrapebnb</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100">

    <header class="bg-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Calendário de Disponibilidade</h1>
                    <p class="text-sm text-gray-600 mt-1">Veja a disponibilidade das suas acomodações.</p>
                </div>
                <a href="/painel" class="flex-shrink-0 ml-4 flex items-center text-sm font-medium text-gray-600 hover:text-indigo-500">
                    <i class="material-icons mr-1">arrow_back</i>
                    Voltar ao Painel
                </a>
            </div>
        </div>
    </header>

    <main class="py-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 space-y-8">
            <section>
                 <div id="rooms-container" class="space-y-8">
                     <p id="rooms-loading-state" class="text-center text-gray-500 bg-white p-6 rounded-lg shadow">Carregando suas acomodações...</p>
                 </div>
            </section>
        </div>
    </main>
    
    <div id="toast-notification" class="hidden fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300">
        <span id="toast-message"></span>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase_auth_airbnb.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const roomsContainer = document.getElementById('rooms-container');
            const roomsLoadingState = document.getElementById('rooms-loading-state');
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            let currentUser = null;

            const showToast = (message, isError = false) => {
                toastMessage.textContent = message;
                toast.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 3000);
            };

            function createCalendar(container, availabilityData) {
                const state = {};
                state.availabilityMap = new Map(availabilityData.map(day => [day.calendar_date, day]));
                const firstDate = availabilityData.length > 0 ? new Date(availabilityData[0].calendar_date + 'T00:00:00') : new Date();
                state.currentDate = new Date(firstDate.getFullYear(), firstDate.getMonth(), 1);

                const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "Sáb"];
                
                let header, daysContainer;

                function updateCalendar() {
                    const year = state.currentDate.getFullYear();
                    const month = state.currentDate.getMonth();

                    header.innerHTML = `
                        <button class="prev-month p-2 rounded-full hover:bg-gray-200 transition-colors"><i class="material-icons pointer-events-none">chevron_left</i></button>
                        <h4 class="text-lg font-semibold">${monthNames[month]} ${year}</h4>
                        <button class="next-month p-2 rounded-full hover:bg-gray-200 transition-colors"><i class="material-icons pointer-events-none">chevron_right</i></button>
                    `;

                    header.querySelector('.prev-month').addEventListener('click', () => changeMonth(-1));
                    header.querySelector('.next-month').addEventListener('click', () => changeMonth(1));

                    daysContainer.innerHTML = '';
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();

                    for (let i = 0; i < firstDayOfMonth; i++) {
                        daysContainer.appendChild(document.createElement('div'));
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayEl = document.createElement('div');
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const availability = state.availabilityMap.get(dateStr);
                        
                        dayEl.textContent = day;
                        dayEl.className = 'p-2 rounded-md text-sm';

                        if (availability) {
                            if (availability.available) {
                                dayEl.classList.add('bg-green-100', 'text-green-800');
                            } else {
                                dayEl.classList.add('bg-red-100', 'text-red-800', 'line-through', 'cursor-not-allowed', 'opacity-75');
                            }
                        } else {
                            dayEl.classList.add('bg-gray-50', 'text-gray-400', 'cursor-not-allowed');
                        }
                        daysContainer.appendChild(dayEl);
                    }
                }
                
                function changeMonth(direction) {
                    state.currentDate.setMonth(state.currentDate.getMonth() + direction);
                    updateCalendar();
                }

                function render() {
                    container.innerHTML = '';
                    
                    const calendarWrapper = document.createElement('div');
                    calendarWrapper.className = 'calendar mt-4';
                    
                    header = document.createElement('div');
                    header.className = 'flex justify-between items-center mb-4';
                    calendarWrapper.appendChild(header);

                    const grid = document.createElement('div');
                    grid.className = 'grid grid-cols-7 gap-1 text-center';
                    
                    dayNames.forEach(day => {
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'font-semibold text-xs text-gray-500 py-2';
                        dayHeader.textContent = day;
                        grid.appendChild(dayHeader);
                    });
                    
                    daysContainer = document.createElement('div');
                    daysContainer.className = 'grid grid-cols-7 gap-1 text-center';
                    
                    calendarWrapper.appendChild(grid);
                    calendarWrapper.appendChild(daysContainer);

                    container.appendChild(calendarWrapper);

                    updateCalendar();
                }
                
                render();
            }

            const fetchAndRenderCalendar = async (roomId, container) => {
                try {
                    container.innerHTML = `
                        <div class="flex items-center justify-center p-4">
                            <svg class="animate-spin h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            <span class="ml-2 text-gray-500">Carregando calendário...</span>
                        </div>`;
                    
                    const response = await fetch('/api/airbnb/disponibility', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ room: roomId })
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    
                    if (result.success && result.availability) {
                        createCalendar(container, result.availability);
                    } else {
                        throw new Error('Dados de disponibilidade inválidos recebidos da API.');
                    }

                } catch (error) {
                    container.innerHTML = `<p class="text-center text-red-500 p-4">Não foi possível carregar o calendário.</p>`;
                    showToast(`Erro ao carregar dados para o quarto ${roomId}.`, true);
                }
            };

            const fetchUserRooms = async () => {
                if (!currentUser) {
                    roomsContainer.innerHTML = '<p class="text-center text-gray-600 bg-white p-6 rounded-lg shadow">Faça login para ver suas acomodações.</p>';
                    return;
                }

                const { data: rooms, error } = await supabase
                    .from('users_rooms')
                    .select('room::text, url')
                    .eq('user_id', currentUser.id);
                
                if (roomsLoadingState) roomsLoadingState.remove();

                if (error) {
                    roomsContainer.innerHTML = '<p class="text-center text-red-500 bg-white p-6 rounded-lg shadow">Erro ao carregar acomodações.</p>';
                    return;
                }
                
                if (rooms.length === 0) {
                    roomsContainer.innerHTML = '<p class="text-center text-gray-600 bg-white p-6 rounded-lg shadow">Você ainda não adicionou nenhuma acomodação.</p>';
                    return;
                }

                roomsContainer.innerHTML = '';
                rooms.forEach(room => {
                    const roomCard = document.createElement('div');
                    roomCard.className = 'bg-white rounded-lg shadow-md p-6';
                    
                    roomCard.innerHTML = `
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                            <img src="${room.url}" alt="Foto da acomodação ${room.room}" class="w-24 h-24 object-cover rounded-lg" onerror="this.onerror=null;this.src='https://placehold.co/100x100/e2e8f0/4a5568?text=Sem+Foto';">
                            <div>
                                <p class="text-sm text-gray-500">Acomodação ID</p>
                                <h3 class="text-2xl font-bold text-gray-800 tracking-wider">${room.room}</h3>
                            </div>
                        </div>
                        <div class="calendar-container border-t border-gray-200 mt-4 pt-4"></div>
                    `;
                    
                    roomsContainer.appendChild(roomCard);
                    
                    const calendarContainer = roomCard.querySelector('.calendar-container');
                    fetchAndRenderCalendar(room.room, calendarContainer);
                });
            };

            const init = async () => {
                const { data: { user } } = await supabase.auth.getUser();
                currentUser = user;
                await fetchUserRooms();
            };

            init();
        });
    </script>
</body>
</html>