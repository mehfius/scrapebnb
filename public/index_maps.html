<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Anúncios no Mapa</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha26-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script src="https://scrapebnb.vercel.app/js/supabase_auth_airbnb.js"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }
        #map-container {
            flex-grow: 1;
            min-height: 0;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        select, input[type="date"] {
            -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='currentColor' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
        }
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }
        #sidebar.is-open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="flex flex-col">

    <header id="app-header" class="bg-white shadow-md p-4 z-40 flex items-center justify-between gap-4 flex-shrink-0">
    </header>

    <div class="relative flex-grow min-h-0">
        <!-- Sidebar de Detalhes (Esquerda) -->
        <aside id="sidebar" class="absolute top-0 left-0 h-full w-96 bg-white shadow-lg transform -translate-x-full z-30 overflow-y-auto">
            <div id="sidebar-content" class="p-6">
                <div class="text-center text-gray-500 mt-8">
                    <span class="material-symbols-outlined text-6xl">real_estate_agent</span>
                    <p class="mt-4">Clique em um anúncio no mapa para ver os detalhes aqui.</p>
                </div>
            </div>
        </aside>

        <!-- Container do Mapa -->
        <main id="map-container" class="relative h-full w-full">
            <div id="map" class="z-10"></div>
            <div id="map-loader" class="hidden absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center z-20">
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900 mx-auto"></div>
                    <p class="mt-4 text-gray-700">Carregando dados...</p>
                </div>
            </div>
        </main>

        <!-- Sidebar de Listagem (Direita) -->
        <aside id="listing-sidebar" class="absolute top-0 right-0 h-full w-48 bg-white shadow-lg z-30 overflow-y-auto">
            <div class="p-4 border-b">
                 <h2 class="text-xl font-bold text-gray-800">Acomodações</h2>
            </div>
            <div id="listing-sidebar-content" class="p-4 space-y-3">
                <!-- A lista de acomodações será injetada aqui -->
            </div>
        </aside>
    </div>

    <script type="module">
        const eHeader = document.getElementById('app-header');
        const eMapLoader = document.getElementById('map-loader');
        const eSidebar = document.getElementById('sidebar');
        const eSidebarContent = document.getElementById('sidebar-content');
        const eListingSidebarContent = document.getElementById('listing-sidebar-content');
        
        let map = null;
        let markersLayer = null;
        let jobs = [];

        const createElement = (tag, options = {}) => {
            const el = document.createElement(tag);
            if (options.id) el.id = options.id;
            if (options.className) el.className = options.className;
            if (options.innerHTML) el.innerHTML = options.innerHTML;
            if (options.type) el.type = options.type;
            if (options.value) el.value = options.value;
            return el;
        };

        const createSelectOption = (value, text) => {
            const opt = createElement('option', { innerHTML: text });
            opt.value = value;
            return opt;
        };

        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);
        const tomorrowFormatted = tomorrow.toISOString().split('T')[0];

        const baseInputClasses = 'bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5';
        
        const eDateLabel = createElement('label', { className: 'font-semibold text-lg whitespace-nowrap' });
        const airbnb = createElement('a', { innerHTML: 'Ver no Airbnb', className: `bg-red-500 text-white px-4 py-2.5 rounded-lg font-semibold hover:bg-red-600 transition-colors text-sm whitespace-nowrap` });
        const eCalendar = createElement('input', { id: 'checkin-calendar', type: 'date', value: tomorrowFormatted, className: `${baseInputClasses} w-full` });
        const eJobSelect = createElement('select', { id: 'job-select', className: `${baseInputClasses} w-96` });
        
        const eHeaderLeft = createElement('div', { className: 'flex items-center gap-4' });
        const eHeaderRight = createElement('div', { className: 'flex items-center gap-2' });

        eHeaderLeft.append(eDateLabel, airbnb);
        eHeaderRight.append(eCalendar, eJobSelect);
        eHeader.append(eHeaderLeft, eHeaderRight);

        const closeSidebar = () => {
            eSidebar.classList.remove('is-open');
        };

        const openSidebar = (item) => {
            const imageUrl = (item.room_image_array && item.room_image_array.length > 0) ? item.room_image_array[0] : item.host_image;
            const price = item.average_price_per_night ? `R$ ${item.average_price_per_night}` : 'N/A';

            eSidebarContent.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Detalhes do Anúncio</h2>
                    <button id="sidebar-close-btn" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="space-y-4">
                    <img src="${imageUrl}" class="w-full h-48 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x192/cccccc/ffffff?text=Imagem';">
                    <h3 class="font-bold text-lg text-gray-900">${item.title}</h3>
                    <p class="text-2xl font-semibold text-gray-800">${price} <span class="text-base font-normal text-gray-600">/ noite</span></p>
                    <div class="flex justify-start items-center gap-6 text-gray-600 border-t pt-4">
                         <div class="flex items-center gap-1.5" title="Favorito">
                            <span class="material-symbols-outlined text-lg ${item.favorite ? 'text-red-500' : 'text-gray-400'}">favorite</span>
                            <span class="text-sm font-medium">Favorito</span>
                         </div>
                         <div class="flex items-center gap-1.5" title="Superhost">
                            <span class="material-symbols-outlined text-lg ${item.superhost ? 'text-yellow-500' : 'text-gray-400'}">star</span>
                            <span class="text-sm font-medium">Superhost</span>
                         </div>
                         <div class="flex items-center gap-1.5" title="Selo Gold">
                            <span class="material-symbols-outlined text-lg ${item.gold ? 'text-amber-400' : 'text-gray-400'}">beenhere</span>
                            <span class="text-sm font-medium">Gold</span>
                         </div>
                    </div>
                    <a href="https://www.airbnb.com.br/rooms/${item.id}" target="_blank" class="block w-full text-center bg-red-500 text-white py-3 rounded-lg font-semibold hover:bg-red-600 transition-all duration-300 shadow-lg hover:shadow-xl mt-2">Ver no Airbnb</a>
                </div>
            `;
            document.getElementById('sidebar-close-btn').addEventListener('click', closeSidebar);
            
            if (!eSidebar.classList.contains('is-open')) {
                eSidebar.classList.add('is-open');
            }
        };

        const updateDateLabel = (dateString) => {
            const date = new Date(dateString + 'T00:00:00');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            eDateLabel.innerHTML = date.toLocaleDateString('pt-BR', options);
        };

        const updateViewJobLink = () => {
            const selectedJobId = eJobSelect.value;
            const job = jobs.find(j => j.id == selectedJobId);
            if (job) {
                const checkinDateString = eCalendar.value;
                const checkoutDate = new Date(checkinDateString + 'T00:00:00');
                checkoutDate.setDate(checkoutDate.getDate() + 3);
                const checkoutDateString = checkoutDate.toISOString().split('T')[0];
                const amenitiesQuery = (job.amenities && job.amenities.length > 0) ? job.amenities.map(a => `&amenities%5B%5D=${a}`).join('') : '';
                const priceQuery = job.price_max ? `&price_max=${job.price_max}&price_filter_input_type=${job.price_filter_input_type}` : '';
                const url = `https://www.airbnb.com.br/s/${job.tag}/homes?adults=${job.adults}&min_bedrooms=${job.min_bedrooms}&check_in=${checkinDateString}&check_out=${checkoutDateString}${amenitiesQuery}${priceQuery}`;
                airbnb.href = url;
                airbnb.target = '_blank';
            } else {
                airbnb.href = '#';
                airbnb.target = '';
            }
        };

        const populateJobSelect = async () => {
            try {
                const response = await fetch(`${globalThis.auth.SUPABASE_URL}/rest/v1/jobs?select=*`, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                jobs = await response.json();
                
                eJobSelect.innerHTML = '';
                let latestJobId = null;

                if (jobs.length > 0) {
                    jobs.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
                    latestJobId = jobs[jobs.length - 1].id;

                    jobs.forEach(job => {
                        const label = `${job.id} | ${job.label || 'N/A'} | Adultos: ${job.adults || 'N/A'} | Quartos: ${job.min_bedrooms || 'N/A'}`;
                        eJobSelect.appendChild(createSelectOption(job.id, label));
                    });
                    eJobSelect.value = latestJobId;
                }
                return latestJobId;
            } catch (error) {
                console.error("Failed to populate jobs:", error);
                return null;
            }
        };

        const fetchDataForDate = async (checkinDate, jobId) => {
            eMapLoader.classList.remove('hidden');
            closeSidebar();

            let url = `${globalThis.auth.SUPABASE_URL}/rest/v1/frontend?select=id,name,gold,room_image_array,position,title,host_image,favorite,superhost,reference_label,average_price_per_night,tagged,latitude,longitude&checkin=eq.${checkinDate}&limit=200&order=position`;
            if (jobId) url += `&job=eq.${jobId}`;

            try {
                const response = await fetch(url, {
                    headers: { 'Apikey': globalThis.auth.SUPABASE_ANON_KEY, "Content-Type": "application/json" }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                markersLayer.clearLayers();
                eListingSidebarContent.innerHTML = ''; // Limpa a lista antiga
                const locationsWithData = data.filter(item => item.latitude && item.longitude);

                if (locationsWithData.length > 0) {
                    const markerBounds = [];
                    locationsWithData.forEach(item => {
                        // Adiciona marcador no mapa
                        const marker = L.marker([item.latitude, item.longitude]);
                        marker.on('click', function (e) {
                            L.DomEvent.stopPropagation(e);
                            openSidebar(item);
                            map.panTo(this.getLatLng());
                        });
                        markersLayer.addLayer(marker);
                        markerBounds.push([item.latitude, item.longitude]);

                        // Adiciona item na lista da sidebar direita
                        const listItem = document.createElement('div');
                        listItem.className = 'p-3 rounded-lg border cursor-pointer hover:bg-gray-100 hover:shadow-md transition-all';
                        listItem.innerHTML = `
                            <div class="flex justify-between items-start">
                                <h4 class="font-semibold text-gray-800 text-sm flex-grow pr-2">${item.title}</h4>
                                <p class="font-bold text-gray-900 text-md whitespace-nowrap">R$ ${item.average_price_per_night || 'N/A'}</p>
                            </div>
                            <div class="flex items-center gap-4 mt-2 text-gray-500">
                                <span class="material-symbols-outlined text-lg ${item.favorite ? 'text-red-400' : 'text-gray-300'}" title="Favorito">favorite</span>
                                <span class="material-symbols-outlined text-lg ${item.superhost ? 'text-yellow-400' : 'text-gray-300'}" title="Superhost">star</span>
                                <span class="material-symbols-outlined text-lg ${item.gold ? 'text-amber-300' : 'text-gray-300'}" title="Selo Gold">beenhere</span>
                            </div>
                        `;
                        listItem.addEventListener('click', () => {
                            openSidebar(item);
                            map.panTo([item.latitude, item.longitude]);
                        });
                        eListingSidebarContent.appendChild(listItem);
                    });
                    map.fitBounds(markerBounds, { padding: [50, 50] });
                } else {
                    eListingSidebarContent.innerHTML = '<p class="text-center text-gray-500 mt-8">Nenhuma acomodação encontrada.</p>';
                    map.setView([-14.2350, -51.9253], 4);
                }

            } catch (error) {
                console.error("Failed to fetch data:", error);
                markersLayer.clearLayers();
                eListingSidebarContent.innerHTML = '<p class="text-center text-red-500 mt-8">Erro ao carregar dados.</p>';
            } finally {
                eMapLoader.classList.add('hidden');
            }
        };

        const handleDateChange = () => {
            const newDate = eCalendar.value;
            fetchDataForDate(newDate, eJobSelect.value);
            updateViewJobLink();
            updateDateLabel(newDate);
        };

        eCalendar.addEventListener('change', handleDateChange);
        eJobSelect.addEventListener('change', () => {
            fetchDataForDate(eCalendar.value, eJobSelect.value);
            updateViewJobLink();
        });

        document.addEventListener('keydown', (event) => {
            if (document.activeElement === eCalendar || document.activeElement === eJobSelect) return;
            
            const currentDate = new Date(eCalendar.value + 'T00:00:00');
            let dateChanged = false;
            if (event.key === 'ArrowLeft') {
                currentDate.setDate(currentDate.getDate() - 1);
                dateChanged = true;
            } else if (event.key === 'ArrowRight') {
                currentDate.setDate(currentDate.getDate() + 1);
                dateChanged = true;
            }
            if (dateChanged) {
                eCalendar.value = currentDate.toISOString().split('T')[0];
                handleDateChange();
            }
        });

        const initializeApp = async () => {
            if (typeof globalThis.auth === 'undefined' || !globalThis.auth.SUPABASE_URL) {
                setTimeout(initializeApp, 1000);
                return;
            }

            map = L.map('map').setView([-14.2350, -51.9253], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('click', closeSidebar);

            const initialJobId = await populateJobSelect();
            fetchDataForDate(tomorrowFormatted, initialJobId);
            updateViewJobLink();
            updateDateLabel(tomorrowFormatted);
        };

        initializeApp();

    </script>
</body>
</html>
